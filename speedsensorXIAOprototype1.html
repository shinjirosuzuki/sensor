<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SWING SENSOR PRO</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* ヘッダー情報 */
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            z-index: 10;
        }

        #timer {
            background-color: #ff0000;
            color: white;
            padding: 5px 15px;
            font-weight: 900;
            font-style: italic;
            font-size: 1.2rem;
        }

        #status {
            font-weight: 900;
            font-size: 0.8rem;
            color: #666;
        }

        /* メインの速度表示エリア */
        #main-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s;
        }

        .speed-unit-group {
            display: flex;
            align-items: baseline;
        }

        #speed-value {
            font-size: 45vw;
            font-weight: 900;
            font-style: italic;
            line-height: 0.8;
            margin: 0;
        }

        #unit {
            font-size: 10vw;
            font-weight: 900;
            font-style: italic;
            margin-left: 10px;
            color: #ff0000;
        }

        /* 履歴エリア */
        #history {
            background: #111;
            display: flex;
            padding: 10px;
            gap: 15px;
            min-height: 60px;
            overflow-x: auto;
            border-top: 1px solid #333;
        }

        .history-item {
            font-style: italic;
            font-weight: 900;
            color: #444;
            font-size: 1.5rem;
        }

        /* 単位切り替えボタン (直径15mm想定: 60px) */
        #unit-toggle-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ff0000;
            color: #fff;
            border: 2px solid #fff;
            font-weight: 900;
            font-style: italic;
            font-size: 12px;
            z-index: 1000;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1.1;
        }

        /* 縦画面レイアウト */
        @media (orientation: portrait) {
            #unit-toggle-btn { bottom: 100px; left: 50%; transform: translateX(-50%); }
        }

        /* 横画面レイアウト */
        @media (orientation: landscape) {
            #unit-toggle-btn { right: 30px; top: 50%; transform: translateY(-50%); }
            #speed-value { font-size: 60vh; }
            #unit { font-size: 15vh; }
        }

        /* 衝撃検知時のフラッシュ効果 */
        .flash { background-color: #ff0000 !important; }

        /* 接続オーバーレイ */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #start-btn {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 25px 50px;
            font-weight: 900;
            font-style: italic;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button id="start-btn">CONNECT TO XIAO</button>
    </div>

    <button id="unit-toggle-btn">UNIT<br>CHG</button>

    <div id="header">
        <div id="timer">00:00.00</div>
        <div id="status">DISCONNECTED</div>
    </div>

    <div id="main-container">
        <div class="speed-unit-group">
            <div id="speed-value">0.0</div>
            <div id="unit">km/h</div>
        </div>
    </div>

    <div id="history"></div>

    <script>
        const BLE_SERVICE_UUID = "1234";
        const BLE_CHARACTERISTIC_UUID = "5678";
        
        let currentUnit = 'km/h';
        let lastKmhValue = 0.0;

        const speedDisplay = document.getElementById('speed-value');
        const unitDisplay = document.getElementById('unit');
        const mainContainer = document.getElementById('main-container');
        const historyList = document.getElementById('history');
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');
        const toggleBtn = document.getElementById('unit-toggle-btn');
        const statusDisplay = document.getElementById('status');

        // 単位切り替えロジック
        toggleBtn.addEventListener('click', () => {
            currentUnit = (currentUnit === 'km/h') ? 'm/s' : 'km/h';
            unitDisplay.innerText = currentUnit;
            refreshDisplay();
        });

        // 数値の再計算表示
        function refreshDisplay() {
            if (currentUnit === 'm/s') {
                speedDisplay.innerText = (lastKmhValue / 3.6).toFixed(1);
            } else {
                speedDisplay.innerText = lastKmhValue.toFixed(1);
            }
        }

        // Bluetooth接続処理
        startBtn.addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'XIAO' }],
                    optionalServices: [BLE_SERVICE_UUID]
                });
                
                statusDisplay.innerText = 'CONNECTING...';
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BLE_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(BLE_CHARACTERISTIC_UUID);

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (e) => {
                    let val = new TextDecoder().decode(e.target.value);
                    lastKmhValue = parseFloat(val);
                    if (!isNaN(lastKmhValue)) {
                        refreshDisplay();
                        triggerFlash();
                        addHistory(lastKmhValue.toFixed(1));
                    }
                });

                statusDisplay.innerText = 'CONNECTED';
                overlay.style.display = 'none';
                
                // 自動フルスクリーン化（ユーザー操作が必要なためここで実行）
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }

            } catch (err) {
                console.error(err);
                alert("Bluetooth接続に失敗しました。HTTPS環境であることを確認してください。");
                statusDisplay.innerText = 'ERROR';
            }
        });

        // 衝撃時の画面フラッシュ
        function triggerFlash() {
            mainContainer.classList.add('flash');
            setTimeout(() => mainContainer.classList.remove('flash'), 100);
        }

        // 履歴の追加
        function addHistory(val) {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerText = val;
            historyList.prepend(item);
        }

        // 簡易タイマー（雰囲気用）
        setInterval(() => {
            const now = new Date();
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const ms = String(Math.floor(now.getMilliseconds()/10)).padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}.${ms}`;
        }, 50);
    </script>
</body>
</html>